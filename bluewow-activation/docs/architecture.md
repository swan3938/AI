# Bluewow 激活数据分析架构文档

## 背景
面向团队内部的数据清洗工具，从半成品数据中读取登录/激活名单，清洗聚合并输出表格与图表，支持原始数据查看与下载。当前版本仅需上传登录/激活名单。

## 产品目标
- 接收一份登录/激活名单（Bluewow已完成匹配），前端上传后自动清洗与提取。
- 依据工号匹配，将公司与主体整合进登录表单并保证准确。
- 识别第一次登录时间作为激活数据，输出激活名单。
- 生成报告：总激活人数、每月激活人数、月度激活柱状图、主体分布；激活率与未激活统计需接入花名册或Bluewow接口后提供。
- 展示月度与总体的业务主体分类统计。
- 未激活人员统计在仅上传登录名单的模式下不可用；后续接入花名册或Bluewow接口后提供。

## 系统架构
- 后端：FastAPI、pandas、APScheduler、SQLite，统一REST接口与审计日志。
- 前端：Vue3、Vite、Element Plus、ECharts，适配飞书WebView。
- 数据流：上传→解析→聚合→缓存→展示与下载→审计。

## 守护进程与任务调度
- APScheduler每日重算缓存与月度汇总，支持手动重算与失败重试。
- 上传事件触发增量重算，长任务线程池隔离，任务状态可查询。

## 安全与合规
- 登录优先使用飞书OAuth，后端签发JWT，内部名单访问控制。
- 角色分级admin/viewer，admin可上传与重算，所有操作审计。
- 上传目录隔离与加密，最小化字段展示，下载鉴权与水印，日志脱敏。

## 可观测性与错误处理
- 操作日志：update_run/upload等在历史记录弹窗显示。
- 错误提示：后端返回可读错误并在前端输出区域显示。
- 指标：同步成功行数、任务耗时与失败率、下载次数。

## 风险与对策
- 字段不一致与缺失：字段映射与上传预览确认，严格校验阻断。
- 时区与日期：统一UTC与YYYY-MM聚合，保留原始时间供审计。
- 匹配错误：仅按employee_id精确匹配，不做模糊匹配。
- 性能与稳定性：大文件分块、限并发、限速下载，幂等与重试。

## 飞书部署
- 企业自建应用，工作台入口打开H5页面，支持机器人消息与卡片。
- 回调与事件：/api/bluewow/feishu/event，OAuth重定向：/api/bluewow/feishu/auth/callback。
- 权限：im:message、im:file、contact:user:readonly等，域名白名单。

## 交付物与接口清单
- 独立工程目录：backend、frontend、docs、infra、scripts。
- 接口：上传、处理、指标、主体、未激活、原始、下载、调度、日志、飞书OAuth与事件。
